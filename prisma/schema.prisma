// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TorrentState {
  @@map("torrent_state")

  Queued
  Verifying
  Error
  Downloading
  Paused
  Finished
}

model Torrent {
  @@map("torrent")

  infoHash            String              @map("info_hash") @unique
  name                String?
  size                BigInt
  state               TorrentState
  progress            Float
  magnetUri           String?             @map("magnet_uri")
  torrentFile         Bytes?              @map("torrent_file")
  errorMessage        String?             @map("error_message")

  createdAt           DateTime            @map("created_at") @default(now())

  torrentClientState1 TorrentClientState? @relation("criticalTorrent")
  files               TorrentFile[]       @relation("torrent")
}

enum TorrentFileState {
  Progress
  Finished
}

model TorrentFile {
  @@map("torrent_file")

  id        Int              @id @default(autoincrement())
  path      String           @unique
  torrentId String           @map("torrent_id")
  state     TorrentFileState
  size      BigInt
  progress  Float

  torrent   Torrent @relation("torrent", fields: [torrentId], references: [infoHash], onDelete: Cascade)
}

model TorrentClientState {
  @@map("torrent_client_state")

  id                 String   @unique
  paused             Boolean
  criticalTorrentId  String?  @map("critical_torrent_id") @unique
  downloadSpeedLimit Float?   @map("download_speed_limit")
  uploadSpeedLimit   Float?   @map("upload_speed_limit")

  criticalTorrent    Torrent? @relation("criticalTorrent", fields: [criticalTorrentId], references: [infoHash], onDelete: SetNull)
}

enum TelegramUserState {
  @@map("telegram_user_state")

  First
  Waiting

  // Devices client
  AddDeviceSetName
  AddDeviceSetType
  AddDeviceSetMac
  AddDeviceSetAddress

  // Torrent client
  SearchRutracker
  AddTorrent
  SetDownloadLimit
  SetUploadLimit
}

model TelegramUserData {
  @@map("telegram_user_data")

  userId           Int               @map("user_id") @unique()
  state            TelegramUserState
  addDevicePayload Json?
}

enum DeviceType {
  @@map("device_type")

  Tv
}

model Device {
  @@map("device")

  id        Int        @id @default(autoincrement())
  name      String
  type      DeviceType
  mac       String
  address   String

  createdAt DateTime   @map("created_at") @default(now())
}
