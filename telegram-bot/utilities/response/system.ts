import systemClient from 'system-client/client';

import { RootCallbackButtonSource } from 'telegram-bot/types/keyboard/root';
import { SystemCallbackButtonSource } from 'telegram-bot/types/keyboard/system';

import Markdown from 'telegram-bot/utilities/Markdown';
import { backCallbackButton, refreshCallbackButton } from 'telegram-bot/utilities/keyboard';
import ImmediateTextResponse from 'telegram-bot/utilities/response/ImmediateTextResponse';
import { formatDuration } from 'utilities/date';
import { formatPercent } from 'utilities/number';
import { formatSize } from 'utilities/size';
import { formatTemperature } from 'utilities/temperature';

export async function getStatusResponse(): Promise<ImmediateTextResponse> {
  const [cpuUsage] = await Promise.all([systemClient.getCpuUsage()]);

  const osTotalMemory = systemClient.getOsTotalMemory();
  const osUsedMemory = osTotalMemory - systemClient.getOsFreeMemory();

  const text = Markdown.create`üíª ${Markdown.bold('–°–∏—Å—Ç–µ–º–∞')}
üßÆ ${Markdown.bold('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU')}: ${formatPercent(cpuUsage.os)}
üõ† ${Markdown.bold('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM')}: ${formatSize(osUsedMemory)} (${formatPercent(osUsedMemory / osTotalMemory)})
üïñ ${Markdown.bold('–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã')}: ${formatDuration(systemClient.getOsUptime())}`;

  if (!systemClient.isWsl()) {
    const cpuTemperature = await systemClient.getCpuTemperature();

    text.add`
üå° ${Markdown.bold('–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ CPU')}: ${formatTemperature(cpuTemperature)}`;
  }

  text.add`


ü§ñ ${Markdown.bold('–ü—Ä–æ—Ü–µ—Å—Å')}
üßÆ ${Markdown.bold('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU')}: ${formatPercent(cpuUsage.process)}
üõ† ${Markdown.bold('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM')}: ${formatSize(systemClient.getProcessUsedMemory())}
üïñ ${Markdown.bold('–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã')}: ${formatDuration(systemClient.getProcessUptime())}`;

  return new ImmediateTextResponse({
    text,
    keyboard: [
      [
        refreshCallbackButton({
          source: SystemCallbackButtonSource.REFRESH_STATUS,
        }),
      ],
      [
        backCallbackButton({
          source: RootCallbackButtonSource.BACK_TO_ROOT,
        }),
      ],
    ],
  });
}
